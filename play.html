<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    /* Navigation Bar */
    #navbar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding: 10px 20px;
      background: #4CAF50; color: white; border-radius: 8px;
    }
    #navbar button {
      margin-left: 10px; padding: 6px 12px; border: none; border-radius: 5px;
      cursor: pointer; background: white; color: #4CAF50; font-weight: bold;
    }
    #navbar button:hover { background: #e8e8e8; }

    /* Containers */
    #friendsContainer, #playDiv {
      background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Main Play Layout */
    #mainContainer { display: flex; gap: 50px; margin-top: 20px; }
    #sliderContainer, #chatContainer { flex: 1; }

    /* Slider */
    #playSlider { width: 100%; margin-top: 10px; }
    #sliderValue { font-weight: bold; margin-left: 10px; }
    #receivedValue { margin-top: 10px; font-size: 1.2em; font-weight: bold; }

    /* Chat */
    #chatMessages {
      height: 300px; overflow-y: auto; padding: 10px; margin-top: 10px;
      border: 1px solid #ccc; border-radius: 10px; background: #f1f1f1;
      display: flex; flex-direction: column; gap: 5px;
    }
    .message {
      padding: 8px 12px; border-radius: 20px; max-width: 70%; word-wrap: break-word;
    }
    .message.self { background: #dcf8c6; align-self: flex-end; }
    .message.friend { background: #e5e5e5; align-self: flex-start; }

    #chatInput { width: 75%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    #sendBtn { padding: 8px 12px; border-radius: 5px; border: none; background: #4CAF50; color: white; cursor: pointer; }
    #sendBtn:hover { background: #45a049; }

    /* Friends List */
    .friendRow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .friendRow button { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; background: #4CAF50; color: white; }
    .friendRow button:hover { background: #45a049; }

    /* Popup */
    .popup {
      position: fixed; top: 20px; right: 20px; background: #fff; border: 1px solid #ccc; padding: 15px; z-index: 1000;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 8px;
    }
    .popup button { margin-left: 10px; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; }
    .popup button:hover { opacity: 0.8; }
    #acceptBtn { background: #4CAF50; color: white; }
    #declineBtn { background: #f44336; color: white; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div id="navbar">
    <div id="userInfo"></div>
    <div>
      <button onclick="goHome()">Home</button>
      <button onclick="goNotifications()">Notifications</button>
      <button onclick="goSearch()">Search Users</button>
      <button onclick="goPlay()">Play</button>
      <button id="signoutBtn">Sign Out</button>
    </div>
  </div>

  <div id="statusDiv" style="margin-bottom:10px;"></div>
  <div id="topicDiv" style="margin-bottom:20px;"></div>

  <!-- Friends list for starting game -->
  <div id="friendsContainer">
    <h3>Choose Friend to Play With</h3>
    <div id="friendsList"></div>
    <label for="roleSelect">Choose Role:</label>
    <select id="roleSelect">
      <option value="sender">Sender</option>
      <option value="receiver">Receiver</option>
    </select>
  </div>

  <!-- Play screen -->
  <div id="playDiv" style="display:none;">
    <div id="mainContainer">
      <!-- Left: Slider -->
      <div id="sliderContainer">
        <h3>Slider Control</h3>
        <input type="range" id="playSlider" min="0" max="100" value="50">
        <span id="sliderValue">50</span>
        <h3>Received Value</h3>
        <div id="receivedValue">Waiting...</div>
        <button id="endGameBtn" style="margin-top:20px; padding:8px 12px; border-radius:5px; border:none; background:#f44336; color:white; cursor:pointer;">End Game</button>
      </div>

      <!-- Right: Chat -->
      <div id="chatContainer">
        <h3>Chat</h3>
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://grykwfxdyqzihegufyvy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyeWt3ZnhkeXF6aWhlZ3VmeXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzAyOTcsImV4cCI6MjA3NTI0NjI5N30.MyuWcHwVUVjbslHrfxwReU0FST0mo-B-lpzsAZkL4oQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let topicName = null;
    let role = null;
    let mqttClient = null;
    let activeGame = null;

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "login.html";
      currentUser = session.user;
      document.getElementById("userInfo").innerText = `User: ${currentUser.email}`;

      const { data: games } = await supabase
        .from("game_sessions")
        .select("*")
        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
        .eq("status","active")
        .order("created_at",{ascending:false})
        .limit(1);

      if (games.length) {
        const game = games[0];
        topicName = game.topic_name;
        role = game.sender_id === currentUser.id ? "sender" : "receiver";
        activeGame = topicName;

        document.getElementById("statusDiv").innerHTML = `Active game as <strong>${role}</strong>`;
        document.getElementById("topicDiv").innerHTML = `Topic: <strong>${topicName}</strong>`;
        document.getElementById("friendsContainer").style.display = "none";
        document.getElementById("playDiv").style.display = "block";
        initMQTT();
      } else {
        document.getElementById("topicDiv").innerHTML = "No active game.";
        loadFriends();
        subscribeIncomingPlayRequests();
      }
    }
    checkSession();

    document.getElementById("signoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    function navigateWithCheck(url) {
      if (activeGame) {
        if (!confirm("Game is active. Do you want to end the game and leave?")) return;
        document.getElementById("endGameBtn").click();
      }
      window.location.href = url;
    }
    function goHome() { navigateWithCheck("home.html"); }
    function goNotifications() { navigateWithCheck("notifications.html"); }
    function goSearch() { navigateWithCheck("search.html"); }
    function goPlay() { navigateWithCheck("play.html"); }

    async function loadFriends() {
      const { data: friendsData } = await supabase
        .from("friendships")
        .select("*")
        .or(`user_id.eq.${currentUser.id},friend_id.eq.${currentUser.id}`)
        .eq("status","accepted");

      const friendsProfiles = [];
      for (let f of friendsData) {
        const friendId = f.user_id === currentUser.id ? f.friend_id : f.user_id;
        const { data: profile } = await supabase
          .from("profiles")
          .select("username,email")
          .eq("id", friendId)
          .single();
        friendsProfiles.push({ ...profile, friendId: friendId });
      }

      renderFriends(friendsProfiles);
    }

    function renderFriends(friends) {
      const div = document.getElementById("friendsList");
      div.innerHTML = "";
      if (!friends.length) { div.innerHTML = "<p>No friends to play with.</p>"; return; }

      friends.forEach(f => {
        const row = document.createElement("div");
        row.classList.add("friendRow");
        row.innerHTML = `
          <span><strong>${f.username}</strong> (${f.email})</span>
          <button onclick="createPlayRequest('${f.friendId}')">Play</button>
        `;
        div.appendChild(row);
      });
    }

    async function acceptPlayRequest(request) {
      await supabase.from("play_requests").update({ status: "accepted" }).eq("id", request.id);

      const sender_id = request.from_role === "sender" ? request.from_user_id : currentUser.id;
      const receiver_id = request.from_role === "receiver" ? request.from_user_id : currentUser.id;

      await supabase.from("game_sessions").insert({
        sender_id,
        receiver_id,
        topic_name: request.topic_name,
        status: "active"
      });

      topicName = request.topic_name;
      role = request.from_role === "sender" ? "receiver" : "sender";
      activeGame = topicName;

      document.getElementById("friendsContainer").style.display = "none";
      document.getElementById("playDiv").style.display = "block";
      document.getElementById("statusDiv").innerHTML = `Active game as <strong>${role}</strong>`;
      document.getElementById("topicDiv").innerHTML = `Topic: <strong>${topicName}</strong>`;

      if (mqttClient) mqttClient.publish(`${topicName}/game_status`, "started");
      initMQTT();
    }

    async function createPlayRequest(friendId) {
      const selectedRole = document.getElementById("roleSelect").value;

      const { data: oldRequests } = await supabase
        .from("play_requests")
        .select("*")
        .eq("from_user_id", currentUser.id)
        .eq("to_user_id", friendId)
        .eq("status", "pending");

      for (let r of oldRequests) {
        await supabase.from("play_requests").update({ status: "denied" }).eq("id", r.id);
      }

      const topic = `game-${Date.now()}-${currentUser.id}-${friendId}`;
      await supabase.from("play_requests").insert({
        from_user_id: currentUser.id,
        to_user_id: friendId,
        from_role: selectedRole,
        status: "pending",
        topic_name: topic
      });

      alert("Play request sent!");
    }

    function subscribeIncomingPlayRequests() {
      const MQTT_URL = "wss://8642b4b309514925a481432e0557cffc.s1.eu.hivemq.cloud:8884/mqtt";
      const MQTT_USERNAME = "imakashadhikary";
      const MQTT_PASSWORD = "Askaban78@#";

      mqttClient = mqtt.connect(MQTT_URL, { username: MQTT_USERNAME, password: MQTT_PASSWORD, clean: true });

      mqttClient.on("connect", () => {
        console.log("MQTT Connected for notifications");
        mqttClient.subscribe(`user/${currentUser.id}/play_requests`);
      });

      mqttClient.on("message", async (topic, message) => {
        if (topic.endsWith("/play_requests")) {
          const data = JSON.parse(message.toString());
          showPopup(`Play request from ${data.from_user_email}`, async () => {
            acceptPlayRequest(data);
          }, async () => {
            await supabase.from("play_requests").update({status:"denied"}).eq("id", data.id);
          });
        }
      });
    }

    function showPopup(msg, onAccept, onDecline) {
      const popup = document.createElement("div");
      popup.classList.add("popup");
      popup.innerHTML = `
        ${msg} 
        <button id="acceptBtn">Accept</button>
        <button id="declineBtn">Decline</button>
      `;
      document.body.appendChild(popup);
      document.getElementById("acceptBtn").addEventListener("click", () => { onAccept(); popup.remove(); });
      document.getElementById("declineBtn").addEventListener("click", () => { onDecline(); popup.remove(); });
    }

    function initMQTT() {
      const MQTT_URL = "wss://8642b4b309514925a481432e0557cffc.s1.eu.hivemq.cloud:8884/mqtt";
      const MQTT_USERNAME = "imakashadhikary";
      const MQTT_PASSWORD = "Askaban78@#";

      mqttClient = mqtt.connect(MQTT_URL, { username: MQTT_USERNAME, password: MQTT_PASSWORD, clean: true });

      mqttClient.on("connect", () => {
        console.log("MQTT Connected for game");
        mqttClient.subscribe(`${topicName}/slider`);
        mqttClient.subscribe(`${topicName}/chat`);
        mqttClient.subscribe(`${topicName}/game`);
        mqttClient.subscribe(`${topicName}/game_status`);
      });

      mqttClient.on("message", (topic, message) => {
        const msg = message.toString();
        if (topic.endsWith("/slider") && role==="receiver") {
          document.getElementById("receivedValue").innerText = msg;
        }
        if (topic.endsWith("/chat")) {
          const chatDiv = document.getElementById("chatMessages");
          const isSelf = msg.startsWith(currentUser.email);
          chatDiv.innerHTML += `<div class="message ${isSelf ? "self":"friend"}">${msg}</div>`;
          chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        if (topic.endsWith("/game_status") && msg==="started") {
          if (!activeGame) { 
            activeGame = topicName; 
            document.getElementById("playDiv").style.display = "block"; 
            document.getElementById("friendsContainer").style.display = "none"; 
          }
        }
        if (topic.endsWith("/game") && msg==="ended") {
          alert("Game ended by other user.");
          activeGame = null;
          topicName = null;
          role = null;
          document.getElementById("playDiv").style.display = "none";
          document.getElementById("friendsContainer").style.display = "block";
        }
      });

      if (role==="sender") {
        document.getElementById("playSlider").addEventListener("input", e => {
          const val = e.target.value;
          document.getElementById("sliderValue").innerText = val;
          if (mqttClient) mqttClient.publish(`${topicName}/slider`, val);
        });
      }

      document.getElementById("sendBtn").addEventListener("click", () => {
        const msg = `${currentUser.email}: ${document.getElementById("chatInput").value}`;
        document.getElementById("chatInput").value = "";
        const chatDiv = document.getElementById("chatMessages");
        chatDiv.scrollTop = chatDiv.scrollHeight;
        if (mqttClient) mqttClient.publish(`${topicName}/chat`, msg);
      });

      document.getElementById("sendBtn").addEventListener("click", () => {
        const input = document.getElementById("chatInput");
        const msgText = input.value.trim();
        if (!msgText) return; // do nothing if empty

        const msg = `${currentUser.email}: ${msgText}`;
        input.value = "";
        input.focus(); // auto-focus after sending

        const chatDiv = document.getElementById("chatMessages");
        chatDiv.scrollTop = chatDiv.scrollHeight;

        if (mqttClient) mqttClient.publish(`${topicName}/chat`, msg);
        });


      document.getElementById("endGameBtn").addEventListener("click", async () => {
        if (!confirm("End the game?")) return;
        if (mqttClient && topicName) mqttClient.publish(`${topicName}/game`, "ended");
        await supabase.from("game_sessions").update({status:"ended"}).eq("topic_name", topicName);
        activeGame = null;
        topicName = null;
        role = null;
        document.getElementById("playDiv").style.display = "none";
        document.getElementById("friendsContainer").style.display = "block";
      });
    }
  </script>
</body>
</html>
