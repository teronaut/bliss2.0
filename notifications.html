<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Notifications</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: #4a90e2;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    nav button {
      background: #fff;
      border: none;
      margin-left: 8px;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: #4a90e2;
      transition: 0.2s;
    }
    nav button:hover {
      background: #e6eefc;
    }
    main {
      padding: 25px;
      max-width: 800px;
      margin: auto;
    }
    h3 {
      margin-top: 30px;
      color: #4a4a4a;
    }
    .card {
      background: #fff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card strong {
      color: #222;
    }
    .actions button {
      margin-left: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.2s;
    }
    .actions .accept {
      background: #28a745;
      color: #fff;
    }
    .actions .accept:hover {
      background: #218838;
    }
    .actions .decline {
      background: #dc3545;
      color: #fff;
    }
    .actions .decline:hover {
      background: #c82333;
    }
    .empty {
      color: #777;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <h1>Notifications</h1>
    <nav>
      <button onclick="goHome()">Home</button>
      <button onclick="goNotifications()">Notifications</button>
      <button onclick="goSearch()">Search Users</button>
      <button onclick="goPlay()">Play</button>
      <button id="signoutBtn">Sign Out</button>
    </nav>
  </header>

  <main>
    <h3>Incoming Friend Requests</h3>
    <div id="friendRequests" class="section"></div>

    <h3>Incoming Play Requests</h3>
    <div id="playRequests" class="section"></div>
  </main>

  <script>
    const SUPABASE_URL = "https://grykwfxdyqzihegufyvy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyeWt3ZnhkeXF6aWhlZ3VmeXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzAyOTcsImV4cCI6MjA3NTI0NjI5N30.MyuWcHwVUVjbslHrfxwReU0FST0mo-B-lpzsAZkL4oQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let mqttClient = null;

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "login.html";
      currentUser = session.user;
      loadFriendRequests();
      loadPlayRequests();
      initMQTT();
    }
    checkSession();

    document.getElementById("signoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    function goHome() { window.location.href = "home.html"; }
    function goNotifications() { window.location.href = "notifications.html"; }
    function goSearch() { window.location.href = "search.html"; }
    function goPlay() { window.location.href = "play.html"; }

    // --- Friend Requests ---
    async function loadFriendRequests() {
      const { data: requests } = await supabase
        .from("friendships")
        .select("*")
        .eq("friend_id", currentUser.id)
        .eq("status", "pending")
        .order("created_at", { ascending: true });

      const div = document.getElementById("friendRequests");
      div.innerHTML = requests.length ? "" : "<p class='empty'>No incoming friend requests.</p>";

      for (let req of requests) {
        const { data: profile } = await supabase
          .from("profiles")
          .select("username,email")
          .eq("id", req.user_id)
          .single();

        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `
          <span><strong>${profile.username}</strong> (${profile.email})</span>
          <div class="actions">
            <button class="accept" onclick="acceptFriend('${req.id}')">Accept</button>
            <button class="decline" onclick="declineFriend('${req.id}')">Decline</button>
          </div>
        `;
        div.appendChild(row);
      }
    }

    async function acceptFriend(requestId) {
      await supabase.from("friendships")
        .update({ status: "accepted", topic_name: "friend_conn_" + crypto.randomUUID() })
        .eq("id", requestId);
      loadFriendRequests();
    }

    async function declineFriend(requestId) {
      await supabase.from("friendships").update({ status: "denied" }).eq("id", requestId);
      loadFriendRequests();
    }

    // --- Play Requests ---
    async function loadPlayRequests() {
      const { data: requests } = await supabase
        .from("play_requests")
        .select("*")
        .eq("to_user_id", currentUser.id)
        .eq("status", "pending")
        .order("created_at", { ascending: true });

      const div = document.getElementById("playRequests");
      div.innerHTML = requests.length ? "" : "<p class='empty'>No incoming play requests.</p>";

      for (let req of requests) {
        const { data: profile } = await supabase
          .from("profiles")
          .select("username,email")
          .eq("id", req.from_user_id)
          .single();

        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `
          <span><strong>${profile.username}</strong> wants to play as <strong>${req.from_role}</strong></span>
          <div class="actions">
            <button class="accept" onclick="acceptPlay(${req.id}, '${req.from_role}')">Accept</button>
            <button class="decline" onclick="declinePlay(${req.id})">Decline</button>
          </div>
        `;
        div.appendChild(row);
      }
    }

    async function acceptPlay(requestId, fromRole) {
      const topicName = "game/conn_" + crypto.randomUUID();
      const toRole = fromRole === "sender" ? "receiver" : "sender";

      await supabase.from("play_requests")
        .update({ status: 'accepted', topic_name: topicName, to_role: toRole })
        .eq("id", requestId);

      await supabase.from("game_sessions").insert({
        sender_id: fromRole==="sender" ? (await getRequestUser(requestId)) : currentUser.id,
        receiver_id: fromRole==="receiver" ? (await getRequestUser(requestId)) : currentUser.id,
        topic_name: topicName,
        status: "active"
      });

      mqttClient.publish(`user/${await getRequestUser(requestId)}/play_status`, JSON.stringify({
        topic: topicName,
        status: "accepted",
        from_user_email: currentUser.email,
        to_role: toRole
      }));

      alert("Play request accepted! Redirecting to play screen...");
      window.location.href = `play.html?topic=${topicName}&role=${toRole}`;
    }

    async function declinePlay(requestId) {
      await supabase.from("play_requests").update({status:"denied"}).eq("id",requestId);
      loadPlayRequests();
    }

    async function getRequestUser(requestId) {
      const { data } = await supabase.from("play_requests").select("*").eq("id", requestId).single();
      return data.from_user_id;
    }

    // --- MQTT ---
    function initMQTT() {
      const MQTT_URL = "wss://8642b4b309514925a481432e0557cffc.s1.eu.hivemq.cloud:8884/mqtt";
      const MQTT_USERNAME = "imakashadhikary";
      const MQTT_PASSWORD = "Askaban78@#";

      mqttClient = mqtt.connect(MQTT_URL, { username: MQTT_USERNAME, password: MQTT_PASSWORD, clean: true });
      mqttClient.on("connect", () => {
        console.log("MQTT connected for notifications");
        mqttClient.subscribe(`user/${currentUser.id}/friend_requests`);
        mqttClient.subscribe(`user/${currentUser.id}/play_requests`);
        mqttClient.subscribe(`user/${currentUser.id}/play_status`);
      });

      mqttClient.on("message", (topic, message) => {
        const data = JSON.parse(message.toString());
        if (topic.endsWith("/play_requests")) {
          alert(`New play request from ${data.from_user_email}`);
          loadPlayRequests();
        }
        if (topic.endsWith("/friend_requests")) {
          alert(`New friend request from ${data.from_user_email}`);
          loadFriendRequests();
        }
        if (topic.endsWith("/play_status")) {
          alert(`${data.from_user_email} accepted your play request! Redirecting to game...`);
          window.location.href = `play.html?topic=${data.topic}&role=${data.to_role}`;
        }
      });
    }
  </script>
</body>
</html>
