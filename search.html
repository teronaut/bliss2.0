<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search Users</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; }
    header { display:flex; justify-content:space-between; align-items:center; padding:15px 25px; background:#4a90e2; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    header h1 { margin:0; font-size:20px; }
    nav button { background:#fff; border:none; margin-left:8px; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:600; color:#4a90e2; transition:0.2s; }
    nav button:hover { background:#e6eefc; }
    main { padding:25px; max-width:800px; margin:auto; }
    .search-bar { display:flex; margin-bottom:25px; }
    .search-bar input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px 0 0 8px; outline:none; font-size:15px; }
    .search-bar button { padding:10px 18px; border:none; background:#4a90e2; color:#fff; border-radius:0 8px 8px 0; cursor:pointer; font-weight:600; transition:0.2s; }
    .search-bar button:hover { background:#357abd; }
    .card { background:#fff; padding:15px; margin:10px 0; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .card strong { color:#222; }
    .card button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; }
    .add { background:#28a745; color:#fff; }
    .add:hover { background:#218838; }
    .revoke { background:#dc3545; color:#fff; }
    .revoke:hover { background:#c82333; }
    .friends { background:#6c757d; color:#fff; cursor:default; }
    .empty { color:#777; font-style:italic; }
  </style>
</head>
<body>
  <header>
    <h1>Search Users</h1>
    <nav>
      <button onclick="goHome()">Home</button>
      <button onclick="goNotifications()">Notifications</button>
      <button onclick="goSearch()">Search Users</button>
      <button onclick="goPlay()">Play</button>
      <button id="signoutBtn">Sign Out</button>
    </nav>
  </header>

  <main>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by username or email..." oninput="filterUsers()" />
      <button onclick="hardSearch()">Search</button>
    </div>
    <div id="userList"></div>
  </main>

  <script>
    const SUPABASE_URL = "https://grykwfxdyqzihegufyvy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyeWt3ZnhkeXF6aWhlZ3VmeXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzAyOTcsImV4cCI6MjA3NTI0NjI5N30.MyuWcHwVUVjbslHrfxwReU0FST0mo-B-lpzsAZkL4oQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let allProfiles = [];

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "login.html";
      currentUser = session.user;
      loadTopProfiles();
    }
    checkSession();

    document.getElementById("signoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    function goHome() { window.location.href="home.html"; }
    function goNotifications() { window.location.href="notifications.html"; }
    function goSearch() { window.location.href="search.html"; }
    function goPlay() { window.location.href="play.html"; }

    async function loadTopProfiles() {
      let { data: profiles, error } = await supabase
        .from("profiles")
        .select("*")
        .neq("id", currentUser.id)
        .limit(15);

      if(error){ console.error(error.message); return; }
      allProfiles = profiles;
      renderUserList(allProfiles);
    }

    function filterUsers() {
      const term = document.getElementById("searchInput").value.trim().toLowerCase();
      if(!term){ renderUserList(allProfiles); return; }
      const filtered = allProfiles.filter(u => u.username.toLowerCase().includes(term) || u.email.toLowerCase().includes(term));
      renderUserList(filtered);
    }

    async function hardSearch() {
      const term = document.getElementById("searchInput").value.trim();
      if(!term){ renderUserList(allProfiles); return; }
      let { data: users, error } = await supabase
        .from("profiles")
        .select("*")
        .or(`username.ilike.%${term}%,email.ilike.%${term}%`)
        .neq("id", currentUser.id)
        .limit(50);
      if(error){ alert(error.message); return; }
      allProfiles = users;
      renderUserList(allProfiles);
    }

    async function renderUserList(users) {
      const div = document.getElementById("userList");
      div.innerHTML = "";
      if(!users.length){ div.innerHTML = "<p class='empty'>No users found.</p>"; return; }

      for(let user of users){
        // Fetch any existing friendship row - check both directions
        let { data: friendships } = await supabase
          .from("friendships")
          .select("*")
          .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${user.id}),and(user_id.eq.${user.id},friend_id.eq.${currentUser.id})`);

        let btnText = "Add Friend";
        let btnClass = "add";
        let actionType = "add";
        let friendshipData = null;

        // Check if there's an ACTIVE friendship (pending or accepted, NOT revoked/declined)
        if(friendships && friendships.length > 0){
          // Find the most recent active friendship
          const activeFriendship = friendships.find(f => 
            f.status === "pending" || f.status === "accepted"
          );
          
          if(activeFriendship){
            friendshipData = activeFriendship;
            
            if(activeFriendship.status === "accepted"){
              btnText = "Friends"; 
              btnClass = "friends"; 
              actionType = "none";
            } else if(activeFriendship.status === "pending"){
              btnText = "Revoke"; 
              btnClass = "revoke"; 
              actionType = "revoke";
            }
          }
          // If no active friendship found (all are revoked/declined), allow new friend request
        }

        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `<span><strong>${user.username}</strong> (${user.email})</span>
          <button id="friendBtn-${user.id}" class="${btnClass}" ${actionType === "none" ? "disabled" : ""}>${btnText}</button>`;
        div.appendChild(row);

        const btn = document.getElementById(`friendBtn-${user.id}`);
        let currentActionType = actionType;
        let currentFriendshipData = friendshipData;

        btn.addEventListener("click", async ()=>{
          if(currentActionType === "add"){
            const newFriendship = await sendFriendRequest(user.id);
            if(newFriendship){
              btn.innerText = "Revoke";
              btn.className = "revoke";
              currentActionType = "revoke";
              currentFriendshipData = newFriendship;
            }
          } else if(currentActionType === "revoke"){
            const success = await revokeFriendRequest(currentFriendshipData.id);
            if(success){
              btn.innerText = "Add Friend";
              btn.className = "add";
              currentActionType = "add";
              currentFriendshipData = null;
            }
          }
        });
      }
    }

    async function sendFriendRequest(friendId){
      try {
        // First, check if there's an existing friendship (revoked or declined)
        const { data: existingFriendships } = await supabase
          .from("friendships")
          .select("*")
          .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${friendId}),and(user_id.eq.${friendId},friend_id.eq.${currentUser.id})`);

        // Check if there's a revoked or declined friendship
        const inactiveFriendship = existingFriendships?.find(f => 
          f.status === "revoked" || f.status === "denied"
        );

        let data, error;

        if(inactiveFriendship){
          // Update the existing revoked/declined friendship to pending
          const result = await supabase
            .from("friendships")
            .update({ 
              status: "pending",
              user_id: currentUser.id,
              friend_id: friendId
            })
            .eq("id", inactiveFriendship.id)
            .select()
            .single();
          data = result.data;
          error = result.error;
        } else {
          // Insert new friendship
          const result = await supabase
            .from("friendships")
            .insert({ 
              user_id: currentUser.id, 
              friend_id: friendId, 
              status: "pending" 
            })
            .select()
            .single();
          data = result.data;
          error = result.error;
        }
        
        if(error){
          console.error("Error sending friend request:", error.message);
          alert("Failed to send friend request: " + error.message);
          return null;
        }
        console.log("Friend request sent successfully!");
        return data;
      } catch(err){
        console.error("Send request failed:", err.message);
        alert("Failed to send friend request");
        return null;
      }
    }

    async function revokeFriendRequest(friendshipId) {
      try {
        console.log("Revoking friendship ID:", friendshipId);
        
        // Update status to "revoked"
        const { data, error } = await supabase
          .from("friendships")
          .update({ status: "revoked" })
          .eq("id", friendshipId)
          .select();

        if (error) {
          console.error("Error revoking friendship:", error.message);
          alert("Failed to revoke request: " + error.message);
          return false;
        }
        
        console.log("Friendship revoked successfully!", data);
        return true;
      } catch (err) {
        console.error("Revoke request failed:", err.message);
        alert("Failed to revoke request");
        return false;
      }
    }

    window.sendFriendRequest = sendFriendRequest;
  </script>
</body>
</html>