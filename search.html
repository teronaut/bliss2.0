<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search Users</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; }
    header { display:flex; justify-content:space-between; align-items:center; padding:15px 25px; background:#4a90e2; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    header h1 { margin:0; font-size:20px; }
    nav button { background:#fff; border:none; margin-left:8px; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:600; color:#4a90e2; transition:0.2s; }
    nav button:hover { background:#e6eefc; }
    main { padding:25px; max-width:800px; margin:auto; }
    .search-bar { display:flex; margin-bottom:25px; }
    .search-bar input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px 0 0 8px; outline:none; font-size:15px; }
    .search-bar button { padding:10px 18px; border:none; background:#4a90e2; color:#fff; border-radius:0 8px 8px 0; cursor:pointer; font-weight:600; transition:0.2s; }
    .search-bar button:hover { background:#357abd; }
    .card { background:#fff; padding:15px; margin:10px 0; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .card strong { color:#222; }
    .card button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; }
    .add { background:#28a745; color:#fff; }
    .add:hover { background:#218838; }
    .revoke { background:#dc3545; color:#fff; }
    .revoke:hover { background:#c82333; }
    .friends { background:#6c757d; color:#fff; cursor:default; }
    .empty { color:#777; font-style:italic; }
  </style>
</head>
<body>
  <header>
    <h1>Search Users</h1>
    <nav>
      <button onclick="goHome()">Home</button>
      <button onclick="goNotifications()">Notifications</button>
      <button onclick="goSearch()">Search Users</button>
      <button onclick="goPlay()">Play</button>
      <button id="signoutBtn">Sign Out</button>
    </nav>
  </header>

  <main>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by username or email..." oninput="filterUsers()" />
      <button onclick="hardSearch()">Search</button>
    </div>
    <div id="userList"></div>
  </main>

  <script>
    const SUPABASE_URL = "https://grykwfxdyqzihegufyvy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyeWt3ZnhkeXF6aWhlZ3VmeXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzAyOTcsImV4cCI6MjA3NTI0NjI5N30.MyuWcHwVUVjbslHrfxwReU0FST0mo-B-lpzsAZkL4oQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let allProfiles = [];

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "login.html";
      currentUser = session.user;
      loadTopProfiles();
    }
    checkSession();

    document.getElementById("signoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    function goHome() { window.location.href="home.html"; }
    function goNotifications() { window.location.href="notifications.html"; }
    function goSearch() { window.location.href="search.html"; }
    function goPlay() { window.location.href="play.html"; }

    async function loadTopProfiles() {
      let { data: profiles, error } = await supabase
        .from("profiles")
        .select("*")
        .neq("id", currentUser.id)
        .limit(15);

      if(error){ console.error(error.message); return; }
      allProfiles = profiles;
      renderUserList(allProfiles);
    }

    function filterUsers() {
      const term = document.getElementById("searchInput").value.trim().toLowerCase();
      if(!term){ renderUserList(allProfiles); return; }
      const filtered = allProfiles.filter(u => u.username.toLowerCase().includes(term) || u.email.toLowerCase().includes(term));
      renderUserList(filtered);
    }

    async function hardSearch() {
      const term = document.getElementById("searchInput").value.trim();
      if(!term){ renderUserList(allProfiles); return; }
      let { data: users, error } = await supabase
        .from("profiles")
        .select("*")
        .or(`username.ilike.%${term}%,email.ilike.%${term}%`)
        .neq("id", currentUser.id)
        .limit(50);
      if(error){ alert(error.message); return; }
      allProfiles = users;
      renderUserList(allProfiles);
    }

    async function renderUserList(users) {
      const div = document.getElementById("userList");
      div.innerHTML = "";
      if(!users.length){ div.innerHTML = "<p class='empty'>No users found.</p>"; return; }

      for(let user of users){
        // Fetch any existing friendship row
        let { data: friendship } = await supabase
          .from("friendships")
          .select("*")
          .or(`user_id.eq.${currentUser.id},friend_id.eq.${currentUser.id}`)
          .or(`user_id.eq.${user.id},friend_id.eq.${user.id}`)
          .limit(1)
          .single();

        let btnText = "Add Friend";
        let btnClass = "add";
        let actionType = "add";

        if(friendship){
          if(friendship.status==="accepted"){
            btnText = "Friends"; btnClass="friends"; actionType="none";
          } else if(friendship.status==="pending"){
            if(friendship.user_id === currentUser.id){
              btnText="Revoke"; btnClass="revoke"; actionType="revoke";
            } else {
              btnText="Revoke"; btnClass="revoke"; actionType="revoke"; // current user can still revoke
            }
          }
        }

        const row = document.createElement("div");
        row.className="card";
        row.innerHTML = `<span><strong>${user.username}</strong> (${user.email})</span>
          <button id="friendBtn-${user.id}" class="${btnClass}">${btnText}</button>`;
        div.appendChild(row);

        document.getElementById(`friendBtn-${user.id}`).addEventListener("click", async ()=>{
          if(actionType==="add"){
            await sendFriendRequest(user.id);
            document.getElementById(`friendBtn-${user.id}`).innerText="Revoke";
            document.getElementById(`friendBtn-${user.id}`).className="revoke";
          } else if(actionType==="revoke"){
            await revokeFriendRequest(friendship.id);
            document.getElementById(`friendBtn-${user.id}`).innerText="Add Friend";
            document.getElementById(`friendBtn-${user.id}`).className="add";
          }
        });
      }
    }

    async function sendFriendRequest(friendId){
      await supabase.from("friendships").insert({ user_id: currentUser.id, friend_id: friendId, status:"pending" });
    }

    async function revokeFriendRequest(friendId) {
  try {
    // Find the friendship row
    const { data: friendship, error } = await supabase
      .from("friendships")
      .select("*")
      .or(
        `(user_id.eq.${currentUser.id},friend_id.eq.${friendId})` + "," +
        `(user_id.eq.${friendId},friend_id.eq.${currentUser.id})`
      )
      .single();

    if (error || !friendship) {
      console.error("Error fetching friendship:", error?.message || "No friendship found");
      return;
    }

    // Update status to "revoked"
    const { error: updateError } = await supabase
      .from("friendships")
      .update({ status: "revoked" })
      .eq("id", friendship.id);

    if (updateError) console.error("Error updating friendship:", updateError.message);
    else console.log("Friendship revoked successfully!");
  } catch (err) {
    console.error("Revoke request failed:", err.message);
  }
}



    window.sendFriendRequest = sendFriendRequest;
  </script>
</body>
</html>
